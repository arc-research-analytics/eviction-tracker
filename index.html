<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eviction Tracker</title>

    <!-- Mapbox JS and CSS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Web Awesome CDN -->
    <link
      rel="stylesheet"
      href="https://early.webawesome.com/webawesome@3.0.0-beta.5/dist/styles/webawesome.css"
    />
    <script
      type="module"
      src="https://early.webawesome.com/webawesome@3.0.0-beta.5/dist/webawesome.loader.js"
    ></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/apartment.png" />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="map"></div>

    <!-- header -->
    <header>
      <span>Metro Atlanta Eviction Tracker </span>
    </header>

    <!-- Month and total evictions display -->
    <div id="monthDisplay">
      <div id="monthText">Loading</div>
      <div id="totalText">and calculating total...</div>

      <!-- insert a button that says "Show County Trends" that exposes a Web Awesome drawer that opens from the top -->
      <wa-button id="countyTrendsBtn" variant="neutral">
        Show County Trends
      </wa-button>
    </div>

    <!-- Full-screen loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-content">
        <wa-spinner style="font-size: 4rem"></wa-spinner>
        <div class="loading-text">Loading eviction data...</div>
      </div>
    </div>

    <!-- Slider at center bottom -->
    <div id="sliderContainer">
      <wa-slider
        id="monthSlider"
        label="Click and drag to change eviction month:"
        min="0"
        max="67"
        value="66"
        step="1"
      ></wa-slider>
      <div id="sliderLabel">May 2025</div>
    </div>

    <!-- About button anchored bottom-left -->
    <wa-button id="aboutBtn" variant="neutral">
      <wa-icon name="info-circle"></wa-icon> About
    </wa-button>

    <!-- About dialog (opened by About button) -->
    <wa-dialog label="About this app" id="aboutDialog">
      <div class="about-dialog">
        <img
          src="assets/arc_logo.png"
          alt="Atlanta Regional Commission logo"
          style="display: block; margin: 0 auto"
        />
        <div>
          <div style="font-weight: 600; margin-bottom: 6px">
            Census Tract Evictions By Month
          </div>
          <div style="color: #555; font-size: 14px; line-height: 1.4">
            This data visualization was built and is maintained by the Atlanta
            Regional Commission's
            <a
              href="https://atlantaregional.org/what-we-do/research-and-data/"
              target="_blank"
              >Research and Analytics</a
            >
            department.
          </div>
        </div>
      </div>
      <wa-button slot="footer" variant="brand" data-dialog="close"
        >Close</wa-button
      >
    </wa-dialog>

    <!-- County Trends drawer (slides in from top) -->
    <wa-drawer
      label="Monthly County Eviction Filings"
      placement="top"
      id="countyTrendsDrawer"
      class="county-trends-drawer"
      style="--size: 85vh"
    >
      <div class="county-trends-content">
        <div class="county-chart-container">
          <canvas id="countyTrendsChart"></canvas>
          <!-- insert text below the chart explaining the grey vertical line -->
          <div class="chart-explanation">
            <p style="font-size: 16px">
              Vertical dashed line represents the time period selected by the
              slider.
            </p>
          </div>
        </div>
        <div id="chartLoadingIndicator" class="chart-loading hidden">
          <wa-spinner style="font-size: 4rem"></wa-spinner>
          <span>Loading chart data...</span>
        </div>
      </div>
      <wa-button slot="footer" variant="brand" data-drawer="close"
        >Close</wa-button
      >
    </wa-drawer>

    <!-- Load config based on environment -->
    <script>
      const isDevelopment =
        location.hostname === "localhost" || location.hostname === "127.0.0.1";
      const configScript = document.createElement("script");
      configScript.src = isDevelopment ? "js/config.dev.js" : "js/config.js";
      document.head.appendChild(configScript);

      configScript.onload = function () {
        // Load modules in the correct order
        const moduleScripts = [
          "js/MonthUtils.js",
          "js/DataLoader.js",
          "js/UIManager.js",
          "js/PopupManager.js",
          "js/TooltipManager.js",
          "js/CountyTrends.js",
          "js/LayerManager.js",
          "js/CursorManager.js",
          "js/InteractionManager.js",
          "js/MapManager.js",
          "js/MapTooltipHandler.js",
          "js/app.js",
        ];

        let loadedScripts = 0;

        function loadNextScript() {
          if (loadedScripts >= moduleScripts.length) return;

          const script = document.createElement("script");
          script.src = moduleScripts[loadedScripts];
          script.onerror = function () {
            console.error(`Failed to load ${moduleScripts[loadedScripts]}`);
          };
          script.onload = function () {
            loadedScripts++;
            loadNextScript();
          };
          document.head.appendChild(script);
        }

        // Start loading the first script
        loadNextScript();
      };
      configScript.onerror = function () {
        console.error("Failed to load config script:", configScript.src);
      };
      // Wire About button to open the dialog once DOM is ready
      (function () {
        const setup = function () {
          const dialog = document.getElementById("aboutDialog");
          const openButton = document.getElementById("aboutBtn");
          if (dialog && openButton) {
            openButton.addEventListener("click", function () {
              dialog.open = true;
            });
          }
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setup, { once: true });
        } else {
          setup();
        }
      })();
    </script>
  </body>
</html>

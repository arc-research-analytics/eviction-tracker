<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eviction Tracker</title>

    <!-- Mapbox JS and CSS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Web Awesome CDN -->
    <link
      rel="stylesheet"
      href="https://early.webawesome.com/webawesome@3.0.0-beta.5/dist/styles/webawesome.css"
    />
    <script
      type="module"
      src="https://early.webawesome.com/webawesome@3.0.0-beta.5/dist/webawesome.loader.js"
    ></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/apartment.png" />

    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <div id="map"></div>

    <!-- header -->
    <header>
      <span>Metro Atlanta Eviction Tracker </span>
      <a
        href="https://atlantaregional.org/"
        target="_blank"
        rel="noopener noreferrer"
      >
        <img
          src="assets/arc_logo.png"
          alt="Atlanta Regional Commission"
          id="headerLogo"
        />
      </a>
    </header>

    <!-- County Trends button in top-left -->
    <wa-button id="countyTrendsBtn" variant="neutral">
      County Trends
      <wa-icon name="arrow-down"></wa-icon>
    </wa-button>

    <!-- Options button in lower-left -->
    <wa-button id="optionsBtn" variant="neutral">
      Map Options
      <wa-icon name="arrow-right"></wa-icon>
    </wa-button>

    <!-- Month and total evictions display -->
    <div id="monthDisplay">
      <div id="monthText">Loading</div>
      <div id="totalText">and calculating total...</div>
    </div>

    <!-- Full-screen loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-content">
        <wa-spinner style="font-size: 4rem"></wa-spinner>
        <div class="loading-text">Loading eviction data...</div>
      </div>
    </div>

    <!-- Slider at center bottom -->
    <div id="sliderContainer">
      <wa-slider
        id="monthSlider"
        label="Click and drag to change the month:"
        min="0"
        max="112"
        value="112"
        step="1"
      ></wa-slider>
      <div id="sliderLabel">May 2025</div>
    </div>

    <!-- About dialog (opened by About button inside Options drawer) -->
    <wa-dialog label="About this app" id="aboutDialog">
      <div class="about-dialog">
        <img
          src="assets/arc_logo.png"
          alt="Atlanta Regional Commission logo"
          style="display: block; margin: 0 auto"
        />
        <div>
          <div style="font-weight: 600; margin-bottom: 6px">
            Census Tract Evictions By Month
          </div>
          <div style="color: #555; font-size: 14px; line-height: 1.4">
            This data visualization was built and is maintained by the Atlanta
            Regional Commission's
            <a
              href="https://atlantaregional.org/what-we-do/research-and-data/"
              target="_blank"
              >Research and Innovation</a
            >
            Team.
          </div>
        </div>
      </div>
      <wa-button slot="footer" variant="brand" data-dialog="close"
        >Close</wa-button
      >
    </wa-dialog>

    <!-- Mobile welcome dialog (auto-opens on mobile devices) -->
    <wa-dialog
      label="Welcome!"
      id="mobileWelcomeDialog"
      style="--width: calc(100vw - 40px); max-width: 500px"
    >
      <div style="line-height: 1.6; color: #333">
        <p style="margin-top: 0">
          Welcome to the Metro Atlanta Eviction Tracker, built by the Atlanta
          Regional Commission's Research and Innovation Team! Please note that
          some features have been disabled on mobile devices for optimal
          performance.
        </p>
        <p style="margin-bottom: 0">
          For the full experience with all features including county trends and
          detailed statistics, please open this web page on a laptop or tablet.
        </p>
      </div>
      <wa-button slot="footer" variant="brand" data-dialog="close"
        >Got it</wa-button
      >
    </wa-dialog>

    <!-- County Trends drawer (slides in from top) -->
    <wa-drawer
      label="Monthly County Eviction Filings"
      placement="top"
      id="countyTrendsDrawer"
      class="county-trends-drawer"
      style="--size: 85vh"
    >
      <div class="county-trends-content">
        <div class="county-chart-container">
          <canvas id="countyTrendsChart"></canvas>
          <!-- insert text below the chart explaining the grey vertical line -->
          <div class="chart-explanation">
            <p style="font-size: 16px">
              <i
                >Vertical dashed line represents the period selected on the
                map's time slider. Click a county in the legend above to hide it
                from the chart.</i
              >
            </p>
          </div>
        </div>
        <div id="chartLoadingIndicator" class="chart-loading hidden">
          <wa-spinner style="font-size: 4rem"></wa-spinner>
          <span>Loading chart data...</span>
        </div>
      </div>
      <wa-button slot="footer" variant="brand" data-drawer="close"
        >Close</wa-button
      >
    </wa-drawer>

    <!-- Options drawer (slides in from left) -->
    <wa-drawer
      label="Map Options"
      placement="start"
      id="optionsDrawer"
      class="options-drawer"
    >
      <div class="options-content">
        <wa-radio-group
          id="geographySelector"
          label="Change Geography:"
          hint="Select a geography level for the eviction tracker"
          orientation="vertical"
          name="geography"
          value="tract"
          style="max-width: 300px"
        >
          <wa-radio appearance="button" value="tract">Census Tract</wa-radio>
          <wa-radio appearance="button" value="school"
            >High School Statistical Area</wa-radio
          >
          <wa-radio appearance="button" value="hex">Hexagon</wa-radio>
        </wa-radio-group>

        <div id="toggleContainer" style="margin-top: 40px">
          <wa-switch id="showRateSwitch" checked
            >Show map as filing rate</wa-switch
          >
        </div>

        <!-- Mobile slider container (slider moved here on mobile) -->
        <div
          id="mobileSliderContainer"
          style="margin-top: 40px; display: none; text-align: center"
        >
          <p
            style="
              margin-bottom: 15px;
              font-size: 14px;
              color: #333;
              font-weight: 600;
            "
          >
            Change eviction filing time period on map
          </p>
        </div>
      </div>
      <div slot="footer" class="drawer-footer-buttons">
        <wa-button id="aboutBtn" variant="neutral">
          <wa-icon name="info-circle"></wa-icon> About
        </wa-button>
        <wa-button variant="brand" data-drawer="close">Close</wa-button>
      </div>
    </wa-drawer>

    <!-- Load config based on environment -->
    <script>
      const isDevelopment =
        location.hostname === "localhost" || location.hostname === "127.0.0.1";
      const configScript = document.createElement("script");
      configScript.src = isDevelopment ? "js/config.dev.js" : "js/config.js";
      document.head.appendChild(configScript);

      configScript.onload = function () {
        // Load modules in the correct order
        const moduleScripts = [
          "js/MonthUtils.js",
          "js/DataLoader.js",
          "js/UIManager.js",
          "js/PopupManager.js",
          "js/TooltipManager.js",
          "js/CountyTrends.js",
          "js/LayerManager.js",
          "js/CursorManager.js",
          "js/InteractionManager.js",
          "js/MapManager.js",
          "js/MapTooltipHandler.js",
          "js/app.js",
        ];

        let loadedScripts = 0;

        function loadNextScript() {
          if (loadedScripts >= moduleScripts.length) return;

          const script = document.createElement("script");
          script.src = moduleScripts[loadedScripts];
          script.onerror = function () {
            console.error(`Failed to load ${moduleScripts[loadedScripts]}`);
          };
          script.onload = function () {
            loadedScripts++;
            loadNextScript();
          };
          document.head.appendChild(script);
        }

        // Start loading the first script
        loadNextScript();
      };
      configScript.onerror = function () {
        console.error("Failed to load config script:", configScript.src);
      };
      // Wire About button to open the dialog once DOM is ready
      (function () {
        const setup = function () {
          const dialog = document.getElementById("aboutDialog");
          const openButton = document.getElementById("aboutBtn");
          if (dialog && openButton) {
            openButton.addEventListener("click", function () {
              dialog.open = true;
            });
          }
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setup, { once: true });
        } else {
          setup();
        }
      })();

      // Wire Options button to open the drawer once DOM is ready
      (function () {
        const setup = function () {
          const drawer = document.getElementById("optionsDrawer");
          const openButton = document.getElementById("optionsBtn");
          if (drawer && openButton) {
            openButton.addEventListener("click", function () {
              drawer.open = true;
            });
          }
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setup, { once: true });
        } else {
          setup();
        }
      })();

      // Auto-open mobile welcome dialog on mobile devices
      (function () {
        const setup = function () {
          const dialog = document.getElementById("mobileWelcomeDialog");
          // Check if viewport width is mobile-sized (768px or less)
          if (dialog && window.innerWidth <= 768) {
            // Small delay to ensure dialog is fully initialized
            setTimeout(() => {
              dialog.open = true;
            }, 500);
          }
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setup, { once: true });
        } else {
          setup();
        }
      })();

      // Set slider orientation to vertical on mobile devices and move to drawer
      (function () {
        const setup = function () {
          const slider = document.getElementById("monthSlider");
          const sliderContainer = document.getElementById("sliderContainer");
          const mobileSliderContainer = document.getElementById(
            "mobileSliderContainer"
          );

          if (
            slider &&
            sliderContainer &&
            mobileSliderContainer &&
            window.innerWidth <= 768
          ) {
            slider.setAttribute("orientation", "vertical");
            // Remove the helper text label on mobile
            slider.removeAttribute("label");

            // Move the entire slider container into the drawer on mobile
            mobileSliderContainer.appendChild(sliderContainer);
            mobileSliderContainer.style.display = "block";
            sliderContainer.style.position = "relative";
            sliderContainer.style.left = "auto";
            sliderContainer.style.bottom = "auto";
            sliderContainer.style.transform = "none";
            sliderContainer.style.margin = "0 auto";
          }
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", setup, { once: true });
        } else {
          setup();
        }
      })();
    </script>
  </body>
</html>
